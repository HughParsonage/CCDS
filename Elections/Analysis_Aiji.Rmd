
---
title: "Analysis_Aiji"
author: "Aiji"
date: "17 November 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
options(dplyr.width=Inf)
```
# Australia's 2016 Election

```{r packages,message=FALSE,warning = FALSE}
library(data.table)
library(dplyr)
library(dtplyr)
library(magrittr)
library(tidyr)
library(ggplot2)
```

the function 'fread' comes from 'data.table' packages
The first argument is either a file or a URL connection to a file. The output is a table
```{r loadData}
tw_party_by_polling_place<-fread("http://results.aec.gov.au/20499/website/Downloads/HouseTppByPollingPlaceDownload-20499.csv")

```

(to run a chunk, press Ctrl+Shift+Enter in the chunk)

```{r basic-analysis}
tw_party_by_polling_place %>%
  summarise(avg_swing = mean(Swing))

```

### Exercices:
1. Can you think of a better way to calculate the 'average' swing againts the incumbent?
2. Can you think of a better way to calculate the 'average' Swing
3. Which polling place had the biggest Swing against the coalition?

We shouldn't weight every polling place equally. A swing of 15% in a polling place of 33 votes shouldn't swamp swing of 2% in a polling place of 2232 votes. Use weighted.mean instead of mean

### 2
```{r weighted_average}
# mean(tw_party_by_polling_place$Swing,na.rm = T)

# weighted average:
tw_party_by_polling_place %>%
summarise(avg_swing = weighted.mean(Swing, w= TotalVotes))
```

Recall that 'summarise' takes a data frame. expression like 'LHS=RHS' returns a data frame with a single column, LHS is the column name and it has the value of function 'RHS'

### 3
```{r wbiggest_swing-coalition}

tw_party_by_polling_place %>%
  filter(Swing==max(Swing)) %>%
  .$PollingPlace

max(tw_party_by_polling_place$Swing)
```

### 2013 Election Exercices
1. Download 2013 election polling place data into a new object named two_party_by_polling_place_2013

```{r get_data}
two_party_by_polling_place_2013<-
  fread("http://results.aec.gov.au/17496/website/Downloads/HouseTppByPollingPlaceDownload-17496.csv")

```
2. Determine, without downloading the relevant dataset, the elected party (ALP or Coalition) of each division in 2013

First, determine the vote percentage for one party, in this case, take coalition. If it exceeds 50%, coalition wins:
```{r elected_2013}
elected_party_by_division_2013<-
  two_party_by_polling_place_2013 %>%
  group_by(DivisionNm) %>%
  summarise(Coalition_2PP = sum(`Liberal/National Coalition Votes`)/sum(TotalVotes)) %>%
  mutate(elected = ifelse(Coalition_2PP >0.5,'Coalition','ALP'))

# mutate is used to add a column
```

## Homework
1. What PollingPlace has the biggest swing against the Coalition? not a division, so amend the previous code
2. Is an inner join appropriate? Should we use outer join instead?

Let's confirm that the swing is against the coalition. 
i.e. swing in 2016 = percentage of votes for coalition in 2016 - percentage of votes for coalition in 2013

```{r check_Swings}
twoYears<-tw_party_by_polling_place %>% 
  inner_join(two_party_by_polling_place_2013,by="PollingPlaceID") %>%
  mutate(ppt_diff_Coalition_votes = `Liberal/National Coalition Percentage.x`-`Liberal/National Coalition Percentage.y`) %>%
  select(PollingPlaceID,contains("Percentage"),ppt_diff_Coalition_votes,Swing.x) 

twoYears %$%
# contains inside select means: select column whose names contain that string
  {
    # using { } allows us to write multiple columns after %$
    stopifnot(all(sign(ppt_diff_Coalition_votes)==sign(Swing.x)))
    # stoprifnot() : stop if any of the conditions are not met
  } 
# result: it stops as all() is not TRUE


data.frame(x=c(1,2),y=c(2,3)) %$% min(x)
# the same with:
data.frame(x=c(1,2),y=c(2,3)) %>% min(.$x)
data.frame(x=c(1,2),y=c(2,3)) %$% min(y) # operate only on the column specified by its name

```

Where are the signs different? And what proportion of the rows have different signs?
We can use 'mean' to test the proportion of TRUE in a column of logical entries
```{r check_the_signs}
different_Swing_sign<- twoYears %>%
  filter(sign(ppt_diff_Coalition_votes)!=sign(Swing.x))


twoYears %$%
  mean(sign(ppt_diff_Coalition_votes)!=sign(Swing.x))

```
Conclusion: 'Swing.x' and 'ppt_diff_Coalition_votes' are different

Answering the homework:
```{r polling-place-biggest swing}
twoYears %>%
  arrange(desc(ppt_diff_Coalition_votes)) %>%
  head(1) 

# %>%
#   inner_join(tw_party_by_polling_place,by = "PollingPlaceID")
#   
```

```{r incumbent_2013}
tw_party_by_polling_place %>% 
  inner_join(elected_party_by_division_2013) # right_join left_join %>%
  

```

# Plotting charts of Election results

```{r 2016-11-17}
polling_places<-fread("http://results.aec.gov.au/20499/Website/Downloads/GeneralPollingPlacesDownload-20499.csv")

which(duplicated(polling_places$PollingPlaceID)) # null

```

Think about a plan to plot the result in a map of each polling place's result. 
Not the actual plot mechanism, but what data you would need to do this

1. PollingPlaceID
2. Longitude
3. Latitude
4. Liberal/National Coalition Percentage

```{r plot_the_coordinate}

polling_places %>%
  select(PollingPlaceID,Latitude,Longitude) %>%
  inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
  ggplot(aes(x= Longitude, y=Latitude)) +
  geom_point()

```

```{r plot_the_winner}

library(ggthemes)
au_map<-polling_places %>%
  select(PollingPlaceID,Latitude,Longitude) %>%
  inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
  mutate(Winner = if_else(`Liberal/National Coalition Percentage` > 50,"Coalition","ALP"))%>%
  ggplot(aes(x= Longitude, y=Latitude,colour= Winner)) +
  geom_point() +
  theme_map()

au_map

```

Let's plot a function to zoom in on a city
Hint: ?coord_map. Just a function choosing either 'SYD' or 'MELB'

```{r}
library(mapproj)
au_map+coord_map()

VIC_places<-polling_places %>%
  filter(State == 'VIC')

VIC_map<-VIC_places %>%
  select(PollingPlaceID,Latitude,Longitude) %>%
  inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
  mutate(Winner = if_else(`Liberal/National Coalition Percentage` > 50,"Coalition","ALP"))%>%
  ggplot(aes(x= Longitude, y=Latitude,colour= Winner)) +
  geom_point() +
  theme_map() +
  coord_map(xlim=c(144.5,145.6),ylim=c(-38.2,-37.5)) + # limiting it t Melbourne only 
  scale_color_manual(values = c("red","blue"))

VIC_map

plot_city("MEL") # should zoom in to MEL

# example of a function:
unabbr_city<-function(abbr){
  switch(abbr,
         "SYD"="Sydney",
         "MEL"="MElbourne",
         "unknown")
  # switch chooses the outcome that its first argument selects
}

plot_MEL<-function(){
  polling_places %>%
  select(PollingPlaceID,Latitude,Longitude) %>%
  inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
  mutate(Winner = if_else(`Liberal/National Coalition Percentage` > 50,"Coalition","ALP"))%>%
  ggplot(aes(x= Longitude, y=Latitude,colour= Winner)) +
  geom_point() +
  theme_map() +
  coord_map(xlim=c(144.5,145.6),ylim=c(-38.2,-37.5)) + # limiting it t Melbourne only 
  scale_color_manual(values = c("red","blue"))
}  
plot_SYD<-function(){
  polling_places %>%
  select(PollingPlaceID,Latitude,Longitude) %>%
  inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
  mutate(Winner = if_else(`Liberal/National Coalition Percentage` > 50,"Coalition","ALP"))%>%
  ggplot(aes(x= Longitude, y=Latitude,colour= Winner)) +
  geom_point() +
  theme_map() +
  coord_map(xlim=c(150.55,151.6),ylim=c(-32.24,-33.6)) + # limiting it t Melbourne only 
  scale_color_manual(values = c("red","blue"))
}  

plot_city<-function(city){
  if(city == "MEL"){    plot_MEL()  }
  else if(city == "SYD") { plot_SYD()  }
}
plot_city('MEL')

 # plot state:
plot_state<-function(x){
  state_places<-polling_places %>%
  filter(State == x)

  state_places %>%
    select(PollingPlaceID,Latitude,Longitude) %>%
    inner_join(tw_party_by_polling_place, by = "PollingPlaceID") %>%
    mutate(Winner = if_else(`Liberal/National Coalition Percentage` > 50,"Coalition","ALP"))%>%
    ggplot(aes(x= Longitude, y=Latitude,colour= Winner)) +
    geom_point() +
    theme_map() + 
    scale_color_manual(values = c("red","blue"))
}

plot_state('QLD')

```
